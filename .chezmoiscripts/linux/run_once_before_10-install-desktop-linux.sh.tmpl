#!/bin/bash
{{- if eq .manualSetup "false" }}
set -e # Exit on error
{{- if eq .isServer "false" }}
{{- if eq .chezmoi.osRelease.id "arch"}}

{{ $normal_packages := list
        "feh"
        "network-manager-applet"
        "ly"
        "make"
        "gcc"
        "base-devel"
        "ranger"
        "alacritty"
        "firefox"
        "gopass"
        "git-credential-gopass"
        "pacman-contrib"
        "qutebrowser"
        "zathura"
        "aerc"
        "ttf-jetbrains-mono-nerd"
        "pavucontrol"
        "mpv"
        "tailscale"
        "obsidian"
-}}

{{ $i3_packages := list
    "i3-wm"
    "picom"
    "xclip"
    "i3lock"
    "xorg-xauth"
    "xss-lock"
    "dunst"
    "rofi"
    "xorg-xkill"
    "xorg-xev"
    "xorg-xinput"
    "xorg-xrdb"
    "polybar"
    "xorg-server"
    "unclutter"
    "arandr"
    "autotiling"
    "pmenuautotiling"
    "python-pystray"
    "enpass-bin"
-}}

{{ $hypr_packages := list
    "brightnessctl"
    "hypridle"
    "hyprland"
    "hyprlock"
    "hyprpaper"
    "pcmanfm"
    "polkit-gnome"
    "waybar"
    "wl-clipboard"
    "wlsunset"
    "rofi-wayland"
    "xdg-desktop-portal-hyprland"
    "enpass-bin"
    "ncspot-bin"
    "grimblast-git"
    "hyprevents-git"
    "hyprpicker"
    "ttf-noto-nerd"
    "hyprprop-git"
-}}
{{ $mobile_packages := list
    "easyroam-desktop-bin"        
-}}
{{ $athena_packages := list
        "gobuster"
        "exploitdb"
        "mitmproxy"
        "nmap"
        "mimikatz"
        "metasploit"
        "radare2"
        "tcpdump"
        "wireshark-qt"
        "wpscan"
        "volatility3"
        "dirbuster"
        "burpsuite"
-}}

{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
{{  $sudo = "" -}}
{{ end -}}


if ! command -v yay &> /dev/null
  then
    echo ""
    {{- if eq .chezmoi.osRelease.id "arch" }}
        pushd .
        git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
        cd /tmp/yay-bin
        makepkg -si --noconfirm
        popd
        rm -rf /tmp/yay-bin/
    {{- end}}
  fi

{{- if eq .isVirtual "false"  }}
    {{ $normal_packages = mustAppend $hypr_packages $normal_packages -}}
    {{ $normal_packages = mustAppend $hypr_packages $mobile_packages -}}
{{- end}}
{{- if eq .isVirtual "true"  }}
    {{ $normal_packages = mustAppend $i3_packages $normal_packages -}}
{{- end}}

{{- if eq .chezmoi.hostname "apophis" }}
    echo "[athena]" | {{ $sudo }} tee -a /etc/pacman.conf
    echo "Include = /etc/pacman.d/athena-mirrorlist" | {{ $sudo }} tee -a /etc/pacman.conf
    echo "SigLevel = Optional TrustedOnly" | {{ $sudo }} tee -a /etc/pacman.conf
    {{ $sudo }} curl https://raw.githubusercontent.com/Athena-OS/athena/main/packages/os-specific/athena-mirrorlist/athena-mirrorlist -o /etc/pacman.d/athena-mirrorlist
    {{ $sudo }} pacman-key --recv-keys A3F78B994C2171D5 --keyserver keys.openpgp.org
    {{ $sudo }} pacman-key --lsign A3F78B994C2171D5
    {{ $normal_packages = mustAppend $athena_packages $normal_packages -}}
{{- end}}

printf '\nUpdating yay packages. Root privileges needed.\n'
yay --noconfirm -S --needed {{ $normal_packages | join " " }}

printf '\n installing ly as service\n'
sudo systemctl enable ly.service
printf '\n Packages are up to date!\n'

{{ else -}}

printf '\nPackage installation is not implemented yet on `' {{ .chezmoi.osRelease.id }} '`.\n'
printf 'You can add it in `run_onchange_install-packages.sh`.\n'

{{ end -}}
{{ end -}}
{{ end -}}
