#!/bin/bash
echo ""
set -eufo pipefail

{{- if eq .manualSetup false }}

# Determine sudo prefix
{{- $sudo := "sudo " }}
{{- if eq .chezmoi.username "root" }}
  {{- $sudo = "" }}
{{- end }}

# Install common packages first
{{- if has "common" .profiles }}
  {{ $sudo }} pacman --needed --noconfirm -Syu {{ .packages.linux.arch.common.packages | join " " }}
{{- end }}

# Install yay if not present
if ! command -v yay &> /dev/null; then
  echo "Installing yay AUR helper..."
  {{- if eq .chezmoi.osRelease.id "arch" }}
  pushd .
  git clone https://aur.archlinux.org/yay-bin.git /tmp/yay-bin
  cd /tmp/yay-bin
  makepkg -si --noconfirm
  popd
  rm -rf /tmp/yay-bin/
  {{- end }}
fi

# Combine packages and services dynamically
{{- $combinedPackages := list -}}
{{- $combinedServices := list -}}
{{- range .profiles }}
  {{- $profile := . -}}
  {{- with (index $.packages.linux.arch $profile) }}
    {{- if .packages }}
      {{- $combinedPackages = concat $combinedPackages .packages -}}
    {{- end }}
    {{- if .services }}
      {{- $combinedServices = concat $combinedServices .services -}}
    {{- end }}
  {{- end }}
{{- end }}

# Handle special case: pentesting repo setup
{{- if has "pentesting" .profiles }}
if ! grep -Fxq "Include = /etc/pacman.d/athena.conf" /etc/pacman.conf; then
    echo "Setting up Athena repository for pentesting..."
    echo "Include = /etc/pacman.d/athena.conf" | {{ $sudo }} tee -a /etc/pacman.conf
    echo "[athena]" | {{ $sudo }} tee /etc/pacman.d/athena.conf
    echo "Include = /etc/pacman.d/athena-mirrorlist" | {{ $sudo }} tee -a /etc/pacman.d/athena.conf
    echo "SigLevel = Optional TrustedOnly" | {{ $sudo }} tee -a /etc/pacman.d/athena.conf
    {{ $sudo }} curl -sSL https://raw.githubusercontent.com/Athena-OS/athena/refs/heads/main/packages/os-specific/system/athena-mirrorlist/athena-mirrorlist -o /etc/pacman.d/athena-mirrorlist
    {{ $sudo }} pacman-key --recv-keys A3F78B994C2171D5 --keyserver keys.openpgp.org
    {{ $sudo }} pacman-key --lsign A3F78B994C2171D5
fi
{{- end }}

# Install all combined packages
if [ {{ len $combinedPackages }} -gt 0 ]; then
  yay -Syu --needed {{ $combinedPackages | join " " }}
fi

# Enable all combined services
{{- range $combinedServices }}
echo "Enabling service: {{ . }}"
{{ $sudo }} systemctl enable {{ . }}
{{- end }}

{{- end }}
