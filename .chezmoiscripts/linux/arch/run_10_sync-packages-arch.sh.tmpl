#!/bin/bash
set -eufo pipefail

# --- 1. Data Gathering (Go Template) ---
{{- $combinedPackages := list -}}
{{- range .profiles -}}
  {{- $profile := . -}}
  {{- with (index $.packages.linux.arch $profile) -}}
    {{- if .packages -}}
      {{- $combinedPackages = concat $combinedPackages .packages -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

# --- 2. Configuration ---
# Add packages here that you want to keep but NOT track in chezmoi
# (e.g., filesystem tools, kernels, drivers)
WHITELIST=(
    "btrfs-progs"
    "linux"
    "linux-firmware"
    "base"
    "amd-ucode"
    "yay-bin"
    "zram-generator"
    "linux-lts"
    "linux-zen"
    "linux-zen-headers"
    "linux-lts-headers"
    "linux-headers"
    "sudo"
    "amd-ucode"
    "networkmanager"
    "ntfs-3g"
    "grub"
    "cups"
    "amdgpu_top"
    "dosfstools"
    "inotify-tools"
    "snapper"
    "syslinux"
    "xf86-video-amdgpu"
    "xf86-video-ati"
    "btrfs-assistant"
    "xorg-server"
    "xorg-xhost"
    "xorg-xinit"
    "vulkan-radeon"
    "xorg-xrandr"
    "efibootmgr"
)

# --- 3. Normalization ---
TARGET_LIST=$(cat <<EOF | LC_ALL=C sort -u
{{ $combinedPackages | join "\n" }}
EOF
)

CURRENT_LIST=$(pacman -Qeq | LC_ALL=C sort -u)

# --- 4. Delta Calculation ---
MISSING=$(LC_ALL=C comm -23 <(echo "$TARGET_LIST") <(echo "$CURRENT_LIST") | sed '/^$/d')

# Initial "Extra" calculation
RAW_EXTRA=$(LC_ALL=C comm -13 <(echo "$TARGET_LIST") <(echo "$CURRENT_LIST") | sed '/^$/d')

# Filter out whitelisted items from the EXTRA list
EXTRA=$(echo "$RAW_EXTRA" | grep -Fvxf <(printf "%s\n" "${WHITELIST[@]}") || true)

# --- 5. The Fancy Dashboard View ---
echo -e "\n\033[1;34mPackage Synchronization\033[0m"
echo -e "------------------------------------------"

if [ -z "$MISSING" ] && [ -z "$EXTRA" ]; then
    echo -e "\033[0;32m✓ System is in sync.\033[0m"
    exit 0
fi

{
    if [ -n "$MISSING" ]; then
        while read -r pkg; do
            echo -e "\033[0;32m[+]\033[0m\t$pkg\t(Install)"
        done <<< "$MISSING"
    fi

    if [ -n "$EXTRA" ]; then
        while read -r pkg; do
            echo -e "\033[0;31m[-]\033[0m\t$pkg\t(Remove)"
        done <<< "$EXTRA"
    fi
} | column -t -s $'\t'

echo -e "------------------------------------------\n"

# --- 6. Execution ---
echo -ne "\033[1;32m➜ sync packages? [y/N]: \033[0m"
read -r confirm_in </dev/tty
if [[ "$confirm_in" =~ ^[Yy]$ ]]; then
    echo "$EXTRA" | xargs -r sudo pacman -Rs --noconfirm
    echo "$MISSING" | xargs -r yay -S --needed --noconfirm
fi
